rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function hasOnlyKeys(data, keys) {
      return data.keys().hasOnly(keys);
    }

    function hasAllKeys(data, keys) {
      return data.keys().hasAll(keys);
    }

    function notificationAllowedKeys() {
      return [
        'type',
        'title',
        'body',
        'payload',
        'createdAt',
        'delivered',
        'deliveredAt',
        'read'
      ];
    }

    function isValidNotificationCreate(data) {
      return hasOnlyKeys(data, notificationAllowedKeys()) &&
        hasAllKeys(data, ['type', 'title', 'body', 'createdAt', 'delivered', 'read']) &&
        data.type is string &&
        data.title is string &&
        data.body is string &&
        (data.payload == null || data.payload is map) &&
        data.createdAt is timestamp &&
        data.delivered == false &&
        data.read == false &&
        (!data.keys().hasAny(['deliveredAt']) || data.deliveredAt == null);
    }

    function isValidNotificationUpdate(newData, existingData) {
      return hasOnlyKeys(newData, notificationAllowedKeys()) &&
        newData.type == existingData.type &&
        newData.title == existingData.title &&
        newData.body == existingData.body &&
        newData.payload == existingData.payload &&
        newData.createdAt == existingData.createdAt &&
        (newData.delivered == existingData.delivered ||
          (existingData.delivered == false && newData.delivered == true)) &&
        (newData.read == existingData.read ||
          (existingData.read == false && newData.read == true)) &&
        (newData.delivered is bool) &&
        (newData.read is bool) &&
        (newData.deliveredAt == existingData.deliveredAt ||
          (newData.deliveredAt == null && newData.delivered == false) ||
          (newData.deliveredAt is timestamp && newData.delivered == true));
    }

    function isTimestampOrServer(value) {
      return value is timestamp || value == request.time;
    }

    function canAccessLounge(loungeId) {
      return loungeId == 'all' ||
        (isSignedIn() &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.accessibleLoungeIds.hasAny([loungeId]));
    }

    function isValidPaystubClientWrite(data, userId) {
      return hasOnlyKeys(data, [
          'status',
          'uploadedAt',
          'updatedAt',
          'detectedTrack',
          'detectedKeywords',
          'errorMessage',
          'originalFileName'
        ]) &&
        hasAllKeys(data, [
          'status',
          'uploadedAt',
          'updatedAt',
          'detectedKeywords',
          'originalFileName'
        ]) &&
        data.status == 'processing' &&
        data.originalFileName is string &&
        data.originalFileName.size() > 0 &&
        (data.detectedTrack == null) &&
        (data.errorMessage == null) &&
        (data.detectedKeywords is list) &&
        isTimestampOrServer(data.uploadedAt) &&
        isTimestampOrServer(data.updatedAt);
    }

    match /users/{userId} {
      allow get: if isSignedIn();       // ê°œë³„ ì‚¬ìš©ì ì¡°íšŒ í—ˆìš©
      allow list: if false;             // ğŸ”’ ì „ì²´ ëª©ë¡ ì¡°íšŒ ì°¨ë‹¨ (ëŒ€ëŸ‰ ìˆ˜ì§‘ ë°©ì§€)
      allow create, update: if isOwner(userId);
      allow delete: if isOwner(userId);

      match /badges/{badgeId} {
        allow read: if isSignedIn();
        allow create, update, delete: if isOwner(userId);
      }

      match /matching_likes/{targetUid} {
        allow read: if isOwner(userId);
        allow create, update, delete: if isOwner(userId);
      }

      match /matching_inbox/{senderUid} {
        allow read: if isOwner(userId);
        allow create, update, delete: if isSignedIn() && request.auth.uid == senderUid;
      }

      match /matching_meta/{docId} {
        allow read: if isOwner(userId);
        allow create, update, delete: if isOwner(userId);
      }

      match /notifications/{notificationId} {
        allow read: if isOwner(userId);
        allow create: if isSignedIn() &&
          isValidNotificationCreate(request.resource.data);
        allow update: if isOwner(userId) &&
          isValidNotificationUpdate(request.resource.data, resource.data);
        allow delete: if isOwner(userId);  // ë³¸ì¸ ì•Œë¦¼ ì‚­ì œ ê°€ëŠ¥
      }

      match /verifications/{verificationId} {
        allow read: if isOwner(userId);
        allow create, update: if isOwner(userId) &&
          verificationId == 'paystub' &&
          isValidPaystubClientWrite(request.resource.data, userId);
        allow delete: if false;
      }

      match /bookmarks/{postId} {
        allow read: if isOwner(userId);
        allow create, update, delete: if isOwner(userId);
      }

      // ğŸ”’ ë¯¼ê° ì •ë³´ ì €ì¥ìš© ì„œë¸Œì»¬ë ‰ì…˜ (ë³¸ì¸ë§Œ ì ‘ê·¼ ê°€ëŠ¥)
      match /private/{docId} {
        allow read, write: if isOwner(userId);
      }
    }

    match /handles/{handle} {
      allow get, list, read: if isSignedIn();
      allow create: if isSignedIn() &&
        request.resource.data.keys().hasOnly(['uid']) &&
        request.resource.data.uid == request.auth.uid;
      allow update, delete: if false;
    }

    match /matches/{matchId} {
      allow read: if isSignedIn() &&
        (resource.data.userA == request.auth.uid || resource.data.userB == request.auth.uid);
      allow create, update: if isSignedIn() &&
        (request.resource.data.userA == request.auth.uid || request.resource.data.userB == request.auth.uid);
      allow delete: if isSignedIn() &&
        (resource.data.userA == request.auth.uid || resource.data.userB == request.auth.uid);
    }

    match /government_email_index/{docId} {
      allow get: if isSignedIn();
      allow list: if false;  // ğŸ”’ ëŒ€ëŸ‰ ì¡°íšŒ ì°¨ë‹¨
      allow create, update: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid;
      allow delete: if false;
    }

    match /government_email_aliases/{docId} {
      allow get: if isSignedIn();
      allow list: if false;  // ğŸ”’ ëŒ€ëŸ‰ ì¡°íšŒ ì°¨ë‹¨
      allow create, update: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid;
      allow delete: if false;
    }

    match /government_email_verification_tokens/{tokenId} {
      allow get: if isSignedIn();
      allow list: if false;  // ğŸ”’ ëŒ€ëŸ‰ ì¡°íšŒ ì°¨ë‹¨
      allow create, update: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid;
      allow delete: if false;
    }

    match /posts/{postId} {
      allow get, list, read: if isSignedIn();
      allow create, update: if isSignedIn();
      allow delete: if isSignedIn() && resource.data.authorId == request.auth.uid;  // ë³¸ì¸ ê¸€ë§Œ ì‚­ì œ ê°€ëŠ¥

      match /comments/{commentId} {
        allow read: if isSignedIn();
        allow create, update: if isSignedIn();
        allow delete: if isSignedIn() && resource.data.authorUid == request.auth.uid;  // ë³¸ì¸ ëŒ“ê¸€ë§Œ ì‚­ì œ ê°€ëŠ¥
      }

      match /comment_likes/{docId} {
        allow read: if isSignedIn();
        allow create, update, delete: if isSignedIn();
      }
    }

    match /likes/{docId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    match /post_counters/{postId} {
      match /shards/{shardId} {
        allow read: if isSignedIn();
        allow create, update, delete: if isSignedIn();
      }
    }

    match /boards/{boardId} {
      allow read: if isSignedIn();
      allow write: if false;
    }

    match /search_suggestions/{token} {
      allow read: if isSignedIn();
      allow create, update: if isSignedIn();
      allow delete: if false;
    }

    match /reports/{reportId} {
      allow read: if false;
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    match /lounges/{loungeId} {
      allow read: if isSignedIn();
      allow write: if false; // ë¼ìš´ì§€ ì •ë³´ëŠ” ê´€ë¦¬ìë§Œ ìˆ˜ì • ê°€ëŠ¥
    }

    match /lounge_posts/{postId} {
      allow read: if isSignedIn() && canAccessLounge(resource.data.loungeId);
      allow create: if isSignedIn() && canAccessLounge(request.resource.data.loungeId) &&
        request.resource.data.authorId == request.auth.uid;
      allow update: if isSignedIn() && canAccessLounge(resource.data.loungeId) &&
        resource.data.authorId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.authorId == request.auth.uid;  // ë³¸ì¸ ë¼ìš´ì§€ ê¸€ë§Œ ì‚­ì œ ê°€ëŠ¥

      match /comments/{commentId} {
        allow read: if isSignedIn() && canAccessLounge(get(/databases/$(database)/documents/lounge_posts/$(postId)).data.loungeId);
        allow create: if isSignedIn() && canAccessLounge(get(/databases/$(database)/documents/lounge_posts/$(postId)).data.loungeId) &&
          request.resource.data.authorId == request.auth.uid;
        allow update: if isSignedIn() && canAccessLounge(get(/databases/$(database)/documents/lounge_posts/$(postId)).data.loungeId) &&
          resource.data.authorId == request.auth.uid;
        allow delete: if isSignedIn() && resource.data.authorUid == request.auth.uid;  // ë³¸ì¸ ë¼ìš´ì§€ ëŒ“ê¸€ë§Œ ì‚­ì œ ê°€ëŠ¥
      }
    }
  }
}
