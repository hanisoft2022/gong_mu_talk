import 'package:flutter/material.dart';
import 'package:flutter/cupertino.dart';
import 'package:flutter/services.dart';
import 'package:gap/gap.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:gong_mu_talk/common/widgets/cupertino_picker_modal.dart';
import 'package:gong_mu_talk/features/calculator/domain/entities/allowance.dart';
import 'package:gong_mu_talk/features/calculator/domain/entities/position.dart';
import 'package:gong_mu_talk/features/calculator/domain/entities/teacher_profile.dart';
import 'package:gong_mu_talk/features/calculator/domain/entities/teaching_allowance_bonus.dart';
import 'package:gong_mu_talk/features/calculator/presentation/widgets/teaching_allowance_selector_dialog.dart';

/// Îπ†Î•∏ ÏûÖÎ†• Bottom Sheet
class QuickInputBottomSheet extends StatefulWidget {
  final TeacherProfile? initialProfile;
  final void Function(TeacherProfile profile) onSubmit;

  const QuickInputBottomSheet({
    super.key,
    this.initialProfile,
    required this.onSubmit,
  });

  @override
  State<QuickInputBottomSheet> createState() => _QuickInputBottomSheetState();
}

class _QuickInputBottomSheetState extends State<QuickInputBottomSheet> {
  late DateTime? _birthDate;
  late int? _currentGrade;
  late Position _position;
  late DateTime _employmentStartDate;
  late int _retirementAge;
  late int _gradePromotionMonth;

  // ÏÉàÎ°úÏö¥ ÏûÖÎ†• Î∞©Ïãù
  bool _isHomeroom = false;
  bool _hasSpouse = false;
  int _numberOfChildren = 0;
  int _numberOfParents = 0; // 60ÏÑ∏ Ïù¥ÏÉÅ ÏßÅÍ≥ÑÏ°¥ÏÜç
  Set<TeachingAllowanceBonus> _teachingAllowanceBonuses = {};

  @override
  void initState() {
    super.initState();
    // Ï∂úÏÉùÏùº: Í∏∞Ï°¥ ÌîÑÎ°úÌïÑÏù¥ ÏûàÏúºÎ©¥ ÏÇ¨Ïö©, ÏóÜÏúºÎ©¥ null
    if (widget.initialProfile != null) {
      _birthDate = DateTime(
        widget.initialProfile!.birthYear,
        widget.initialProfile!.birthMonth,
        1,
      );
    } else {
      _birthDate = null;
    }

    // ÌòÑÏû¨ Ìò∏Î¥â: ÎîîÌè¥Ìä∏ ÏóÜÏùå (ÌïÑÏàò ÏÑ†ÌÉù)
    _currentGrade = widget.initialProfile?.currentGrade;

    // ÏßÅÍ∏â: Ìï≠ÏÉÅ ÍµêÏÇ¨Î°ú Í≥†Ï†ï
    _position = Position.teacher;

    // ÏûÑÏö©Ïùº: 2025ÎÖÑ 3Ïõî 1Ïùº ÎîîÌè¥Ìä∏
    _employmentStartDate =
        widget.initialProfile?.employmentStartDate ?? DateTime(2025, 3, 1);

    _retirementAge = widget.initialProfile?.retirementAge ?? 62;

    // Ìò∏Î¥â ÏäπÍ∏âÏõî: Í∏∞Î≥∏ 3Ïõî
    _gradePromotionMonth = widget.initialProfile?.gradePromotionMonth ?? 3;

    // Í∏∞Ï°¥ allowancesÍ∞Ä ÏûàÏúºÎ©¥ Ï∂îÏ†ï
    if (widget.initialProfile != null) {
      _isHomeroom = widget.initialProfile!.allowances.homeroom > 0;
      _teachingAllowanceBonuses =
          widget.initialProfile!.teachingAllowanceBonuses;

      // Í∏∞Ï°¥ allowancesÏóê headTeacherÍ∞Ä ÏûàÏúºÎ©¥ teachingAllowanceBonusesÏóê Ï∂îÍ∞Ä
      if (widget.initialProfile!.allowances.headTeacher > 0 &&
          !_teachingAllowanceBonuses.contains(TeachingAllowanceBonus.headTeacher)) {
        _teachingAllowanceBonuses = {
          ..._teachingAllowanceBonuses,
          TeachingAllowanceBonus.headTeacher,
        };
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    return Container(
      decoration: const BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
      ),
      child: DraggableScrollableSheet(
        initialChildSize: 0.7,
        minChildSize: 0.5,
        maxChildSize: 0.9,
        expand: false,
        builder: (context, scrollController) {
          return Column(
            children: [
              // Ìï∏Îì§
              Container(
                margin: const EdgeInsets.only(top: 12, bottom: 8),
                width: 40,
                height: 4,
                decoration: BoxDecoration(
                  color: Colors.grey[300],
                  borderRadius: BorderRadius.circular(2),
                ),
              ),

              // Ï†úÎ™©
              Padding(
                padding: const EdgeInsets.symmetric(
                  horizontal: 20,
                  vertical: 8,
                ),
                child: Row(
                  children: [
                    const Icon(Icons.rocket_launch, color: Colors.blue),
                    const Gap(12),
                    Text(
                      'Îπ†Î•∏ Í≥ÑÏÇ∞ (3Ï¥à ÏôÑÏÑ±!)',
                      style: Theme.of(context).textTheme.titleLarge?.copyWith(
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ],
                ),
              ),

              const Divider(),

              // ÏûÖÎ†• Ìèº
              Expanded(
                child: ListView(
                  controller: scrollController,
                  padding: const EdgeInsets.all(20),
                  children: [
                    // ÏÉùÎÖÑÏõî
                    _buildSectionTitle('üìç Ï∂úÏÉù Ïó∞Ïõî'),
                    const Gap(8),
                    InkWell(
                      onTap: () async {
                        final initialDate = _birthDate ?? DateTime(1990, 1, 1);
                        int tempYear = initialDate.year;
                        int tempMonth = initialDate.month;

                        await showCupertinoModalPopup(
                          context: context,
                          builder: (BuildContext context) {
                            return DefaultTextStyle(
                              style: GoogleFonts.notoSansKr(
                                color: Colors.black87,
                              ),
                              child: Container(
                                height: 300,
                                decoration: const BoxDecoration(
                                  color: Colors.white,
                                  borderRadius: BorderRadius.vertical(
                                    top: Radius.circular(16),
                                  ),
                                ),
                                child: Column(
                                  children: [
                                    // Header
                                    Container(
                                      height: 50,
                                      decoration: BoxDecoration(
                                        color: Colors.white,
                                        border: Border(
                                          bottom: BorderSide(
                                            color: Colors.grey.shade300,
                                            width: 0.5,
                                          ),
                                        ),
                                        borderRadius:
                                            const BorderRadius.vertical(
                                              top: Radius.circular(16),
                                            ),
                                      ),
                                      child: Row(
                                        mainAxisAlignment:
                                            MainAxisAlignment.spaceBetween,
                                        children: [
                                          CupertinoButton(
                                            minimumSize: Size.zero,
                                            padding: const EdgeInsets.symmetric(
                                              horizontal: 12,
                                            ),
                                            child: Text(
                                              'Ï∑®ÏÜå',
                                              style: TextStyle(
                                                color: Colors.grey.shade600,
                                                fontSize: 16,
                                              ),
                                            ),
                                            onPressed: () =>
                                                Navigator.pop(context),
                                          ),
                                          const Text(
                                            'Ï∂úÏÉù Ïó∞Ïõî ÏÑ†ÌÉù',
                                            style: TextStyle(
                                              fontWeight: FontWeight.w600,
                                              fontSize: 16,
                                              color: Colors.black87,
                                            ),
                                          ),
                                          CupertinoButton(
                                            minimumSize: Size.zero,
                                            padding: const EdgeInsets.symmetric(
                                              horizontal: 12,
                                            ),
                                            child: Text(
                                              'ÏôÑÎ£å',
                                              style: TextStyle(
                                                color: Theme.of(
                                                  context,
                                                ).primaryColor,
                                                fontSize: 16,
                                                fontWeight: FontWeight.w600,
                                              ),
                                            ),
                                            onPressed: () {
                                              HapticFeedback.mediumImpact();
                                              setState(() {
                                                _birthDate = DateTime(
                                                  tempYear,
                                                  tempMonth,
                                                  1,
                                                );
                                              });
                                              Navigator.pop(context);
                                            },
                                          ),
                                        ],
                                      ),
                                    ),
                                    // Year and Month Pickers
                                    Expanded(
                                      child: CupertinoTheme(
                                        data: CupertinoThemeData(
                                          textTheme: CupertinoTextThemeData(
                                            pickerTextStyle:
                                                GoogleFonts.notoSansKr(
                                                  color: Colors.black87,
                                                  fontSize: 20,
                                                ),
                                          ),
                                        ),
                                        child: Row(
                                          children: [
                                            // Year Picker
                                            Expanded(
                                              child: CupertinoPicker(
                                                scrollController:
                                                    FixedExtentScrollController(
                                                  initialItem:
                                                      initialDate.year - 1960,
                                                ),
                                                itemExtent: 40,
                                                backgroundColor: Colors.white,
                                                diameterRatio: 1.5,
                                                squeeze: 1.2,
                                                magnification: 1.1,
                                                useMagnifier: true,
                                                selectionOverlay: Container(
                                                  decoration: BoxDecoration(
                                                    border: Border.symmetric(
                                                      horizontal: BorderSide(
                                                        color: Theme.of(context)
                                                            .primaryColor
                                                            .withValues(
                                                              alpha: 0.3,
                                                            ),
                                                        width: 1.5,
                                                      ),
                                                    ),
                                                    color: Theme.of(context)
                                                        .primaryColor
                                                        .withValues(alpha: 0.05),
                                                  ),
                                                ),
                                                onSelectedItemChanged: (index) {
                                                  HapticFeedback
                                                      .selectionClick();
                                                  tempYear = 1960 + index;
                                                },
                                                children: List.generate(
                                                  DateTime.now().year -
                                                      1960 +
                                                      1,
                                                  (index) {
                                                    final year = 1960 + index;
                                                    return Center(
                                                      child: Text('$yearÎÖÑ'),
                                                    );
                                                  },
                                                ),
                                              ),
                                            ),
                                            // Month Picker
                                            Expanded(
                                              child: CupertinoPicker(
                                                scrollController:
                                                    FixedExtentScrollController(
                                                  initialItem:
                                                      initialDate.month - 1,
                                                ),
                                                itemExtent: 40,
                                                backgroundColor: Colors.white,
                                                diameterRatio: 1.5,
                                                squeeze: 1.2,
                                                magnification: 1.1,
                                                useMagnifier: true,
                                                selectionOverlay: Container(
                                                  decoration: BoxDecoration(
                                                    border: Border.symmetric(
                                                      horizontal: BorderSide(
                                                        color: Theme.of(context)
                                                            .primaryColor
                                                            .withValues(
                                                              alpha: 0.3,
                                                            ),
                                                        width: 1.5,
                                                      ),
                                                    ),
                                                    color: Theme.of(context)
                                                        .primaryColor
                                                        .withValues(alpha: 0.05),
                                                  ),
                                                ),
                                                onSelectedItemChanged: (index) {
                                                  HapticFeedback
                                                      .selectionClick();
                                                  tempMonth = index + 1;
                                                },
                                                children: List.generate(12, (index) {
                                                  final month = index + 1;
                                                  return Center(
                                                    child: Text('$monthÏõî'),
                                                  );
                                                }),
                                              ),
                                            ),
                                          ],
                                        ),
                                      ),
                                    ),
                                  ],
                                ),
                              ),
                            );
                          },
                        );
                      },
                      child: InputDecorator(
                        decoration: const InputDecoration(
                          border: OutlineInputBorder(),
                          labelText: 'Ï∂úÏÉù Ïó∞ÎèÑ Î∞è Ïõî',
                          suffixIcon: Icon(Icons.calendar_today),
                        ),
                        child: Text(
                          _birthDate != null
                              ? '${_birthDate!.year}ÎÖÑ ${_birthDate!.month}Ïõî'
                              : 'ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî',
                          style: TextStyle(
                            color: _birthDate != null ? null : Colors.grey,
                          ),
                        ),
                      ),
                    ),

                    const Gap(24),

                    // ÌòÑÏû¨ Ìò∏Î¥â
                    _buildSectionTitle('üìç ÌòÑÏû¨ Ìò∏Î¥â'),
                    const Gap(8),
                    InkWell(
                      onTap: _showGradePicker,
                      child: InputDecorator(
                        decoration: const InputDecoration(
                          border: OutlineInputBorder(),
                          labelText: 'Ìò∏Î¥â ÏÑ†ÌÉù (ÌïÑÏàò)',
                          suffixIcon: Icon(Icons.school),
                        ),
                        child: Text(
                          _currentGrade != null
                              ? '$_currentGradeÌò∏Î¥â'
                              : 'Ìò∏Î¥âÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî',
                          style: TextStyle(
                            color: _currentGrade != null ? null : Colors.grey,
                          ),
                        ),
                      ),
                    ),

                    const Gap(24),

                    // ÏûÑÏö©Ïùº
                    _buildSectionTitle('üìç ÏûÑÏö©Ïùº'),
                    const Gap(8),
                    InkWell(
                      onTap: () async {
                        DateTime tempDate = _employmentStartDate;

                        await showCupertinoModalPopup(
                          context: context,
                          builder: (BuildContext context) {
                            return DefaultTextStyle(
                              style: GoogleFonts.notoSansKr(
                                color: Colors.black87,
                              ),
                              child: Container(
                                height: 300,
                                decoration: const BoxDecoration(
                                  color: Colors.white,
                                  borderRadius: BorderRadius.vertical(
                                    top: Radius.circular(16),
                                  ),
                                ),
                                child: Column(
                                  children: [
                                    // Header
                                    Container(
                                      height: 50,
                                      decoration: BoxDecoration(
                                        color: Colors.white,
                                        border: Border(
                                          bottom: BorderSide(
                                            color: Colors.grey.shade300,
                                            width: 0.5,
                                          ),
                                        ),
                                        borderRadius:
                                            const BorderRadius.vertical(
                                              top: Radius.circular(16),
                                            ),
                                      ),
                                      child: Row(
                                        mainAxisAlignment:
                                            MainAxisAlignment.spaceBetween,
                                        children: [
                                          CupertinoButton(
                                            minimumSize: Size.zero,
                                            padding: const EdgeInsets.symmetric(
                                              horizontal: 12,
                                            ),
                                            child: Text(
                                              'Ï∑®ÏÜå',
                                              style: TextStyle(
                                                color: Colors.grey.shade600,
                                                fontSize: 16,
                                              ),
                                            ),
                                            onPressed: () =>
                                                Navigator.pop(context),
                                          ),
                                          const Text(
                                            'ÏûÑÏö©Ïùº ÏÑ†ÌÉù',
                                            style: TextStyle(
                                              fontWeight: FontWeight.w600,
                                              fontSize: 16,
                                              color: Colors.black87,
                                            ),
                                          ),
                                          CupertinoButton(
                                            minimumSize: Size.zero,
                                            padding: const EdgeInsets.symmetric(
                                              horizontal: 12,
                                            ),
                                            child: Text(
                                              'ÏôÑÎ£å',
                                              style: TextStyle(
                                                color: Theme.of(
                                                  context,
                                                ).primaryColor,
                                                fontSize: 16,
                                                fontWeight: FontWeight.w600,
                                              ),
                                            ),
                                            onPressed: () {
                                              HapticFeedback.mediumImpact(); // ÏôÑÎ£å Î≤ÑÌäº ÌñÖÌã±
                                              setState(() {
                                                _employmentStartDate = tempDate;
                                              });
                                              Navigator.pop(context);
                                            },
                                          ),
                                        ],
                                      ),
                                    ),
                                    // Date Picker
                                    Expanded(
                                      child: CupertinoTheme(
                                        data: CupertinoThemeData(
                                          textTheme: CupertinoTextThemeData(
                                            dateTimePickerTextStyle:
                                                GoogleFonts.notoSansKr(
                                                  color: Colors.black87,
                                                  fontSize: 20,
                                                ),
                                          ),
                                        ),
                                        child: CupertinoDatePicker(
                                          mode: CupertinoDatePickerMode.date,
                                          backgroundColor: Colors.white,
                                          initialDateTime: _employmentStartDate,
                                          minimumYear: 1980,
                                          maximumDate: DateTime.now(),
                                          onDateTimeChanged: (DateTime picked) {
                                            HapticFeedback.selectionClick(); // ÎÇ†Ïßú Î≥ÄÍ≤Ω Ïãú ÌñÖÌã±
                                            tempDate = picked;
                                          },
                                        ),
                                      ),
                                    ),
                                  ],
                                ),
                              ),
                            );
                          },
                        );
                      },
                      child: InputDecorator(
                        decoration: const InputDecoration(
                          border: OutlineInputBorder(),
                          suffixIcon: Icon(Icons.calendar_today),
                        ),
                        child: Text(
                          '${_employmentStartDate.year}ÎÖÑ ${_employmentStartDate.month}Ïõî ${_employmentStartDate.day}Ïùº',
                        ),
                      ),
                    ),

                    const Gap(32),

                    // ÏÑ†ÌÉù ÏûÖÎ†• (Ï†ëÏùÑ Ïàò ÏûàÎäî ÏÑπÏÖò)
                    ExpansionTile(
                      title: const Text('‚öôÔ∏è Îçî Ï†ïÌôïÌïòÍ≤å Í≥ÑÏÇ∞ÌïòÍ∏∞ (ÏÑ†ÌÉù)'),
                      children: [
                        // Ìò∏Î¥â ÏäπÍ∏âÏõî
                        Padding(
                          padding: const EdgeInsets.all(16),
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              const Text(
                                'Ìò∏Î¥â ÏäπÍ∏âÏõî',
                                style: TextStyle(
                                  fontSize: 16,
                                  fontWeight: FontWeight.w600,
                                ),
                              ),
                              const Gap(8),
                              InkWell(
                                onTap: _showGradePromotionMonthPicker,
                                child: InputDecorator(
                                  decoration: const InputDecoration(
                                    border: OutlineInputBorder(),
                                    suffixIcon: Icon(Icons.calendar_month),
                                  ),
                                  child: Text('$_gradePromotionMonthÏõî'),
                                ),
                              ),
                              const Gap(4),
                              Text(
                                'Ìò∏Î¥âÏù¥ ÏäπÍ∏âÎêòÎäî ÏõîÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî (ÏùºÎ∞òÏ†ÅÏúºÎ°ú 3Ïõî)',
                                style: TextStyle(
                                  fontSize: 12,
                                  color: Colors.grey.shade600,
                                ),
                              ),
                            ],
                          ),
                        ),

                        const Divider(),

                        // ÍµêÏßÅ ÏàòÎãπ
                        Padding(
                          padding: const EdgeInsets.all(16),
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              const Text(
                                'ÍµêÏßÅ ÏàòÎãπ',
                                style: TextStyle(
                                  fontSize: 16,
                                  fontWeight: FontWeight.w600,
                                ),
                              ),
                              const Gap(12),
                              SwitchListTile(
                                title: const Text('Îã¥ÏûÑ ÏàòÎãπ (Í∞ÄÏÇ∞Í∏à 4)'),
                                subtitle: const Text('Îã¥ÏûÑÏùº Í≤ΩÏö∞ Ïõî 20ÎßåÏõê ÏßÄÍ∏â'),
                                value: _isHomeroom,
                                onChanged: (val) => setState(() => _isHomeroom = val),
                                contentPadding: EdgeInsets.zero,
                              ),
                              const Gap(8),
                              // ÍµêÏßÅÏàòÎãπ Í∞ÄÏÇ∞Í∏à ÏÑ†ÌÉù (Î≥¥ÏßÅÍµêÏÇ¨ Ìè¨Ìï®)
                              ListTile(
                                title: const Text('ÍµêÏßÅÏàòÎãπ Í∞ÄÏÇ∞Í∏à'),
                                subtitle: _teachingAllowanceBonuses.isEmpty
                                    ? const Text('Î≥¥ÏßÅÍµêÏÇ¨, ÌäπÏàòÍµêÏÇ¨ Îì± ÏÑ†ÌÉù')
                                    : Text(
                                        _teachingAllowanceBonuses
                                            .map((b) => b.displayName)
                                            .join(', '),
                                      ),
                                trailing: const Icon(Icons.chevron_right),
                                contentPadding: EdgeInsets.zero,
                                onTap: _showTeachingAllowanceBonusesSelector,
                              ),
                            ],
                          ),
                        ),

                        const Divider(),

                        // Í∞ÄÏ°±ÏàòÎãπ
                        Padding(
                          padding: const EdgeInsets.symmetric(horizontal: 16),
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              const Text(
                                'Í∞ÄÏ°±ÏàòÎãπ',
                                style: TextStyle(
                                  fontSize: 16,
                                  fontWeight: FontWeight.w600,
                                ),
                              ),
                              const Gap(12),
                              SwitchListTile(
                                title: const Text('Î∞∞Ïö∞Ïûê'),
                                subtitle: const Text('Ïõî 4ÎßåÏõê'),
                                value: _hasSpouse,
                                onChanged: (val) =>
                                    setState(() => _hasSpouse = val),
                                contentPadding: EdgeInsets.zero,
                              ),
                              const Gap(8),
                              const Text(
                                'ÏûêÎÖÄ Ïàò',
                                style: TextStyle(
                                  fontSize: 15,
                                  fontWeight: FontWeight.w500,
                                ),
                              ),
                              const Gap(8),
                              InkWell(
                                onTap: _showNumberOfChildrenPicker,
                                child: InputDecorator(
                                  decoration: const InputDecoration(
                                    border: OutlineInputBorder(),
                                    suffixIcon: Icon(Icons.family_restroom),
                                    contentPadding: EdgeInsets.symmetric(
                                      horizontal: 12,
                                      vertical: 12,
                                    ),
                                  ),
                                  child: Text('$_numberOfChildrenÎ™Ö'),
                                ),
                              ),
                              const Gap(4),
                              Text(
                                'Ï≤´Ïß∏ 5ÎßåÏõê, ÎëòÏß∏ 8ÎßåÏõê, ÏÖãÏß∏ Ïù¥ÏÉÅ Í∞Å 12ÎßåÏõê',
                                style: TextStyle(
                                  fontSize: 12,
                                  color: Colors.grey.shade600,
                                ),
                              ),
                              const Gap(16),
                              const Text(
                                '60ÏÑ∏ Ïù¥ÏÉÅ Î∂ÄÎ™®Îãò (ÏßÅÍ≥ÑÏ°¥ÏÜç)',
                                style: TextStyle(
                                  fontSize: 15,
                                  fontWeight: FontWeight.w500,
                                ),
                              ),
                              const Gap(8),
                              InkWell(
                                onTap: _showNumberOfParentsPicker,
                                child: InputDecorator(
                                  decoration: const InputDecoration(
                                    border: OutlineInputBorder(),
                                    suffixIcon: Icon(Icons.elderly),
                                    contentPadding: EdgeInsets.symmetric(
                                      horizontal: 12,
                                      vertical: 12,
                                    ),
                                  ),
                                  child: Text('$_numberOfParentsÎ™Ö'),
                                ),
                              ),
                              const Gap(4),
                              Text(
                                '1Ïù∏Îãπ 2ÎßåÏõê (ÏµúÎåÄ 4Î™Ö)',
                                style: TextStyle(
                                  fontSize: 12,
                                  color: Colors.grey.shade600,
                                ),
                              ),
                            ],
                          ),
                        ),

                        const Gap(16),

                        const Divider(),

                        // Ìá¥ÏßÅ ÏòàÏ†ï Ïó∞Î†π
                        Padding(
                          padding: const EdgeInsets.all(16),
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Row(
                                children: [
                                  const Text(
                                    'Ìá¥ÏßÅ ÏòàÏ†ï Ïó∞Î†π',
                                    style: TextStyle(
                                      fontSize: 16,
                                      fontWeight: FontWeight.w600,
                                    ),
                                  ),
                                  const Gap(4),
                                  GestureDetector(
                                    onTap: () {
                                      showDialog(
                                        context: context,
                                        builder: (context) => AlertDialog(
                                          title: const Text('Ìá¥ÏßÅ ÏòàÏ†ï Ïó∞Î†π ÏïàÎÇ¥'),
                                          content: const Text(
                                            'ÌòÑÏû¨ Î≤ïÏ†ï Ï†ïÎÖÑ: Îßå 62ÏÑ∏\n\n'
                                            '‚Ä¢ 60ÏÑ∏: Ï°∞Í∏∞ Ìá¥ÏßÅ (Ïó∞Í∏à Í∞êÏï° Í∞ÄÎä•)\n'
                                            '‚Ä¢ 62ÏÑ∏: ÌòÑÌñâ Î≤ïÏ†ï Ï†ïÎÖÑ (Í∏∞Î≥∏Í∞í)\n'
                                            '‚Ä¢ 65ÏÑ∏: Ï†ïÎÖÑ Ïó∞Ïû• ÏãúÎÇòÎ¶¨Ïò§ (ÎØ∏ÌôïÏ†ï)',
                                          ),
                                          actions: [
                                            TextButton(
                                              onPressed: () => Navigator.pop(context),
                                              child: const Text('ÌôïÏù∏'),
                                            ),
                                          ],
                                        ),
                                      );
                                    },
                                    child: Icon(
                                      Icons.info_outline,
                                      size: 18,
                                      color: Colors.grey[600],
                                    ),
                                  ),
                                ],
                              ),
                              const Gap(8),
                              InkWell(
                                onTap: _showRetirementAgePicker,
                                child: InputDecorator(
                                  decoration: const InputDecoration(
                                    border: OutlineInputBorder(),
                                    suffixIcon: Icon(Icons.cake),
                                  ),
                                  child: Text('$_retirementAgeÏÑ∏'),
                                ),
                              ),
                              const Gap(4),
                              _buildRetirementAgeDescription(),
                            ],
                          ),
                        ),

                        const Gap(16),
                      ],
                    ),

                    const Gap(32),

                    // Í≥ÑÏÇ∞ Î≤ÑÌäº
                    ElevatedButton(
                      onPressed: _handleSubmit,
                      style: ElevatedButton.styleFrom(
                        padding: const EdgeInsets.symmetric(vertical: 16),
                        textStyle: const TextStyle(
                          fontSize: 18,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                      child: const Text('üìä Î∞îÎ°ú Í≥ÑÏÇ∞ÌïòÍ∏∞'),
                    ),

                    const Gap(24),
                  ],
                ),
              ),
            ],
          );
        },
      ),
    );
  }

  Widget _buildSectionTitle(String title) {
    return Text(
      title,
      style: const TextStyle(fontSize: 16, fontWeight: FontWeight.w600),
    );
  }

  Widget _buildRetirementAgeDescription() {
    String description;
    Color color;

    switch (_retirementAge) {
      case 60:
        description = 'Ï°∞Í∏∞ Ìá¥ÏßÅ (Ïó∞Í∏à Í∞êÏï° Í∞ÄÎä•)';
        color = Colors.orange;
        break;
      case 62:
        description = 'ÌòÑÌñâ Î≤ïÏ†ï Ï†ïÎÖÑ';
        color = Colors.green;
        break;
      case 65:
        description = 'Ï†ïÎÖÑ Ïó∞Ïû• ÏãúÎÇòÎ¶¨Ïò§ (ÎØ∏ÌôïÏ†ï)';
        color = Colors.blue;
        break;
      default:
        description = '';
        color = Colors.grey;
    }

    if (description.isEmpty) return const SizedBox.shrink();

    return Row(
      children: [
        Icon(Icons.info_outline, size: 14, color: color),
        const Gap(4),
        Text(
          description,
          style: TextStyle(fontSize: 12, color: color),
        ),
      ],
    );
  }

  Future<void> _showGradePicker() async {
    final selectedGrade = await CupertinoPickerModal.show<int>(
      context: context,
      title: 'Ìò∏Î¥â ÏÑ†ÌÉù',
      items: List.generate(35, (i) => i + 6), // 6-40Ìò∏Î¥â
      initialItem: _currentGrade ?? 15,
      itemBuilder: (grade) => '$gradeÌò∏Î¥â',
    );

    if (selectedGrade != null) {
      setState(() {
        _currentGrade = selectedGrade;
      });
    }
  }

  Future<void> _showRetirementAgePicker() async {
    final selectedAge = await CupertinoPickerModal.show<int>(
      context: context,
      title: 'Ìá¥ÏßÅ ÏòàÏ†ï Ïó∞Î†π',
      items: List.generate(6, (i) => i + 60), // 60-65ÏÑ∏
      initialItem: _retirementAge,
      itemBuilder: (age) => '$ageÏÑ∏',
    );

    if (selectedAge != null) {
      setState(() {
        _retirementAge = selectedAge;
      });
    }
  }

  Future<void> _showGradePromotionMonthPicker() async {
    final selectedMonth = await CupertinoPickerModal.show<int>(
      context: context,
      title: 'Ìò∏Î¥â ÏäπÍ∏âÏõî',
      items: List.generate(12, (i) => i + 1), // 1-12Ïõî
      initialItem: _gradePromotionMonth,
      itemBuilder: (month) => '$monthÏõî',
    );

    if (selectedMonth != null) {
      setState(() {
        _gradePromotionMonth = selectedMonth;
      });
    }
  }

  Future<void> _showNumberOfChildrenPicker() async {
    final selectedChildren = await CupertinoPickerModal.show<int>(
      context: context,
      title: 'ÏûêÎÖÄ Ïàò ÏÑ†ÌÉù',
      items: List.generate(6, (i) => i), // 0-5Î™Ö
      initialItem: _numberOfChildren,
      itemBuilder: (count) => '$countÎ™Ö',
    );

    if (selectedChildren != null) {
      setState(() {
        _numberOfChildren = selectedChildren;
      });
    }
  }

  Future<void> _showNumberOfParentsPicker() async {
    final selectedParents = await CupertinoPickerModal.show<int>(
      context: context,
      title: '60ÏÑ∏ Ïù¥ÏÉÅ Î∂ÄÎ™®Îãò',
      items: List.generate(5, (i) => i), // 0-4Î™Ö
      initialItem: _numberOfParents,
      itemBuilder: (count) => '$countÎ™Ö',
    );
    if (selectedParents != null) {
      setState(() {
        _numberOfParents = selectedParents;
      });
    }
  }

  void _handleSubmit() {
    // ÏÉùÎÖÑÏõî ÌïÑÏàò ÏûÖÎ†• Í≤ÄÏ¶ù
    if (_birthDate == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Ï∂úÏÉù Ïó∞ÏõîÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.'),
          backgroundColor: Colors.orange,
        ),
      );
      return;
    }

    // Ìò∏Î¥â ÌïÑÏàò ÏûÖÎ†• Í≤ÄÏ¶ù
    if (_currentGrade == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('ÌòÑÏû¨ Ìò∏Î¥âÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.'),
          backgroundColor: Colors.orange,
        ),
      );
      return;
    }

    // ÏÉàÎ°úÏö¥ Î∞©Ïãù: AllowanceÎäî Í∏∞Î≥∏Í∞íÏúºÎ°ú ÏÑ§Ï†ï
    // Ïã§Ï†ú ÏàòÎãπ Í≥ÑÏÇ∞ÏùÄ SalaryCalculationServiceÏóêÏÑú Ï≤òÎ¶¨

    // Î≥¥ÏßÅÍµêÏÇ¨ Ïó¨Î∂ÄÎäî teachingAllowanceBonusesÏóêÏÑú ÌåêÎã®
    final hasPosition = _teachingAllowanceBonuses.contains(
      TeachingAllowanceBonus.headTeacher,
    );

    final profile = TeacherProfile(
      birthYear: _birthDate!.year,
      birthMonth: _birthDate!.month,
      currentGrade: _currentGrade!,
      position: _position,
      employmentStartDate: _employmentStartDate,
      retirementAge: _retirementAge,
      gradePromotionMonth: _gradePromotionMonth,
      allowances: Allowance(
        homeroom: _isHomeroom ? 200000 : 0,
        headTeacher: hasPosition ? 150000 : 0,
        family: 0, // MonthlyBreakdownService._calculateFamilyAllowance ÏÇ¨Ïö©
        veteran: 0, // MonthlyBreakdownService._calculateVeteranAllowance ÏÇ¨Ïö©
      ),
      hasSpouse: _hasSpouse,
      numberOfChildren: _numberOfChildren,
      numberOfParents: _numberOfParents,
      isHomeroom: _isHomeroom,
      hasPosition: hasPosition,
      teachingAllowanceBonuses: _teachingAllowanceBonuses,
    );

    widget.onSubmit(profile);
    Navigator.pop(context);
  }

  Future<void> _showTeachingAllowanceBonusesSelector() async {
    final result = await TeachingAllowanceSelectorDialog.show(
      context,
      initialSelection: _teachingAllowanceBonuses,
    );

    if (result != null) {
      setState(() {
        _teachingAllowanceBonuses = result;
      });
    }
  }
}
